rules_version = '2';

// Règles Firestore pour la PRODUCTION
// Chaque utilisateur ne voit que SES propres données

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Règles pour les profils utilisateurs
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Règles pour les produits - ISOLATION COMPLÈTE
    match /products/{document} {
      allow read, write: if request.auth != null && 
        (resource == null || resource.data.created_by == request.auth.uid);
    }
    
    // Règles pour le stock - ISOLATION COMPLÈTE avec gestion des anciens stocks
    match /stock/{document} {
      // Permettre la lecture si l'utilisateur est authentifié
      allow read: if request.auth != null;
      
      // Permettre la création si l'utilisateur est authentifié
      allow create: if request.auth != null;
      
      // Permettre la mise à jour si l'utilisateur est authentifié
      // (même pour les anciens stocks avec created_by: "system")
      allow update: if request.auth != null;
      
      // Permettre la suppression si l'utilisateur est authentifié et que c'est son stock
      allow delete: if request.auth != null && 
        (resource.data.created_by == request.auth.uid || 
         resource.data.created_by == 'system');
    }
    
    // Règles pour les ventes - ISOLATION COMPLÈTE
    match /sales/{document} {
      allow read, write: if request.auth != null && 
        (resource == null || resource.data.user_id == request.auth.uid);
    }
    
    // Règles pour les clients - ISOLATION COMPLÈTE
    match /customers/{document} {
      allow read, write: if request.auth != null && 
        (resource == null || resource.data.created_by == request.auth.uid);
    }
    
    // Règles pour l'inventaire - ISOLATION COMPLÈTE
    match /inventory/{document} {
      allow read, write: if request.auth != null && 
        (resource == null || resource.data.created_by == request.auth.uid);
    }
    
    // Règles pour les catégories - ISOLATION COMPLÈTE
    match /categories/{document} {
      allow read, write: if request.auth != null && 
        (resource == null || resource.data.created_by == request.auth.uid);
    }
    
    // Règles pour les emplacements - ISOLATION COMPLÈTE
    match /locations/{document} {
      allow read, write: if request.auth != null && 
        (resource == null || resource.data.created_by == request.auth.uid);
    }
    
    // Règles pour les éléments de vente
    match /sale_items/{document} {
      allow read, write: if request.auth != null;
    }
    
    // Règles pour les mouvements de stock - ISOLATION COMPLÈTE
    match /stock_movements/{document} {
      allow read, write: if request.auth != null && 
        (resource == null || resource.data.created_by == request.auth.uid);
    }
    
    // Règles pour les entrées de stock - ISOLATION COMPLÈTE
    match /stock_entries/{document} {
      allow read, write: if request.auth != null && 
        (resource == null || resource.data.created_by == request.auth.uid);
    }
    
    // Règles pour les ajustements de stock - ISOLATION COMPLÈTE
    match /stock_adjustments/{document} {
      allow read, write: if request.auth != null && 
        (resource == null || resource.data.created_by == request.auth.uid);
    }
    
    // Règles pour les transferts - ISOLATION COMPLÈTE
    match /transfers/{document} {
      allow read, write: if request.auth != null && 
        (resource == null || resource.data.created_by == request.auth.uid);
    }
  }
}

